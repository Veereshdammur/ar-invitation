<!DOCTYPE html>
<html>
<head>
    <title>Birthday Invitation AR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="styles/main.css">
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.4.0/dist/aframe-master.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <div id="permission-button" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; background: #007bff; color: white; padding: 15px 30px; border-radius: 25px; cursor: pointer; display: none;">
        Click to Enable Camera
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        loading-screen="enabled: false">
        <a-entity
            id="invitation-entity"
            geometry="primitive: plane;"
            material="shader: flat; src: invitation.jpeg?v=${Date.now()}; transparent: true; opacity: 1; side: double"
            position="0 0 -1"
            look-at="[camera]"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 15000; easing: linear">
        </a-entity>
        <a-camera position="0 0 0" look-controls-enabled="false"></a-camera>
    </a-scene>

    <div id="loading-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center;">
        <p>Loading Birthday Invitation AR Experience...</p>
    </div>

    <div id="mobile-instructions" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-family: Arial; display: none; text-align: center;">
        Move your phone around to view the invitation
    </div>

    <script>
        async function requestCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop()); // Stop the stream after getting permission
                document.getElementById('permission-button').style.display = 'none';
                location.reload(); // Reload after getting permission
            } catch (err) {
                console.error('Error accessing camera:', err);
                document.getElementById('permission-button').style.display = 'block';
            }
        }

        // Check camera permission on load
        document.addEventListener('DOMContentLoaded', () => {
            const permButton = document.getElementById('permission-button');
            permButton.addEventListener('click', requestCameraPermission);
            
            navigator.permissions.query({ name: 'camera' })
                .then(permissionStatus => {
                    if (permissionStatus.state === 'denied') {
                        permButton.style.display = 'block';
                    }
                });
        });

        function adjustInvitationSize() {
            const invitationEntity = document.getElementById('invitation-entity');
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            // Increased size - now 40% of screen width for mobile (up from 25%)
            const targetWidth = screenWidth * 0.40;
            // Using actual invitation aspect ratio (width:height = 3:2)
            const aspectRatio = 1.5;
            
            // Convert to AR units with adjusted scale
            const arWidth = (targetWidth / 1500); // Reduced divisor for larger size
            const arHeight = arWidth / aspectRatio;

            // Update entity geometry
            invitationEntity.setAttribute('geometry', {
                primitive: 'plane',
                width: arWidth,
                height: arHeight
            });

            // Adjust position to be slightly further from camera
            invitationEntity.setAttribute('position', {
                x: 0,
                y: 0,
                z: -0.8 // Moved slightly back for better view of larger size
            });
        }

        function forceImageReload() {
            const invitationEntity = document.getElementById('invitation-entity');
            const randomVersion = Math.random(); // Generate random number
            invitationEntity.setAttribute('material', {
                shader: 'flat',
                src: `invitation.jpeg?v=${randomVersion}`,
                transparent: true,
                opacity: 1,
                side: 'double'
            });
            console.log('Reloading image with version:', randomVersion);
        }

        // Initial size adjustment
        window.addEventListener('load', adjustInvitationSize);
        
        // Adjust size when screen is resized or orientation changes
        window.addEventListener('resize', adjustInvitationSize);
        window.addEventListener('orientationchange', adjustInvitationSize);

        document.querySelector('a-scene').addEventListener('loaded', function () {
            document.getElementById('loading-screen').style.display = 'none';
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                document.getElementById('mobile-instructions').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('mobile-instructions').style.display = 'none';
                }, 5000);
                adjustInvitationSize();
            }
        });

        document.querySelector('a-entity').addEventListener('materialtextureloaded', function() {
            console.log('Image texture loaded successfully');
            adjustInvitationSize();
        });

        document.querySelector('a-entity').addEventListener('error', function(e) {
            console.error('Error loading image:', e);
        });
    </script>
</body>
</html>
